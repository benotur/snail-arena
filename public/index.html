<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snail Arena</title>
    <link rel="stylesheet" href="styles/main.css">
        <!-- Firebase App (the core Firebase SDK) -->
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
        <!-- Firebase Realtime Database -->
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div id="alert-container"></div>
    <!-- Challenge Window (hidden by default, opened by button) -->
    <div id="challenge-window" style="display:none;position:fixed;top:50%;left:32px;transform:translateY(-50%);z-index:210;background:rgba(20,20,20,0.98);border-radius:18px;padding:24px 32px;box-shadow:0 4px 24px #000;max-width:340px;min-width:220px;max-height:70vh;overflow-y:auto;">
        <div style="font-size:22px;font-weight:bold;color:#ffd700;margin-bottom:12px;text-align:center;">Challenges</div>
        <div id="dailyChallenge" class="info" style="margin-bottom:18px;"></div>
        <div id="weeklyChallenge" class="info"></div>
        <button id="close-challenge-window" style="margin-top:18px;padding:7px 18px;border-radius:8px;background:#222;color:#ffd700;font-size:15px;border:none;cursor:pointer;">Close</button>
    </div>
    <!-- Challenges Button (icon only) -->
    <button id="open-challenge-window" style="position:fixed;top:24px;right:24px;z-index:252;padding:12px 18px;border-radius:50px;background:#222;color:#ffd700;font-size:22px;border:none;cursor:pointer;pointer-events:auto;display:inline-flex;align-items:center;gap:8px;margin-bottom:8px;">
        üèÜ
    </button>
    <!-- Username Input (hidden by default) -->
    <div id="username-container" style="position:fixed;top:10px;right:50%;transform:translateX(50%);z-index:200;background:#222;padding:10px 20px;border-radius:8px;box-shadow:0 0 8px #4caf50;display:none;">
            <label for="username-input" style="color:#fff;font-family:inherit;font-size:15px;">Username:</label>
            <input id="username-input" type="text" style="font-size:15px;padding:4px 10px;border-radius:4px;border:1px solid #4caf50;">
            <button id="username-confirm" style="font-size:15px;padding:4px 12px;border-radius:4px;border:1px solid #4caf50;background:#4caf50;color:#222;cursor:pointer;">OK</button>
        </div>
    <!-- Mutation Book Menu (integrated, same style as Hazard Book) -->
    <div id="mutation-book-menu" style="position:fixed;top:50px;right:50px;z-index:301;background:rgba(20,20,20,0.98);border-radius:18px;padding:24px 32px;box-shadow:0 4px 24px #000;display:none;max-width:340px;min-width:220px;max-height:70vh;overflow-y:auto;">
    <div style="font-size:22px;font-weight:bold;color:#ffd700;margin-bottom:12px;text-align:center;">Mutation Book</div>
    <div style="font-size:13px;color:#fff;margin-bottom:14px;text-align:center;line-height:1.4;">Unlock mutations by progressing in prestige, surviving hazards, reaching slime milestones, or through rare events and daily challenges.</div>
    <div id="mutation-book-list" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px 14px;"></div>
    <button id="close-mutation-book" style="margin-top:18px;padding:7px 18px;border-radius:8px;background:#222;color:#ffd700;font-size:15px;border:none;cursor:pointer;">Close</button>
    </div>
    <!-- Mutation Book Button (icon only) -->
    <button id="open-mutation-book" style="position:fixed;top:72px;right:24px;z-index:251;padding:12px 18px;border-radius:50px;background:#222;color:#ffd700;font-size:22px;border:none;cursor:pointer;pointer-events:auto;margin-bottom:8px;display:inline-flex;align-items:center;gap:8px;">
        üß¨
    </button>
    <!-- Hazard Book Menu -->
    <div id="hazard-book-menu" style="position:fixed;top:50px;right:50px;z-index:300;background:rgba(20,20,20,0.98);border-radius:18px;padding:24px 32px;box-shadow:0 4px 24px #000;display:none;max-width:340px;min-width:220px;">
        <div style="font-size:22px;font-weight:bold;color:#ffd700;margin-bottom:12px;text-align:center;">Hazard Book</div>
        <div id="hazard-book-list"></div>
        <button id="close-hazard-book" style="margin-top:18px;padding:7px 18px;border-radius:8px;background:#222;color:#ffd700;font-size:15px;border:none;cursor:pointer;">Close</button>
    </div>
    <!-- Hazard Book Button (icon only) -->
    <button id="open-hazard-book" style="position:fixed;top:120px;right:24px;z-index:250;padding:12px 18px;border-radius:50px;background:#222;color:#ffd700;font-size:22px;border:none;cursor:pointer;margin-bottom:8px;display:inline-flex;align-items:center;gap:8px;">
        ‚ö†Ô∏è
    </button>
    <!-- Pet Book Menu -->
    <div id="pet-book-menu" style="position:fixed;top:50px;right:50px;z-index:302;background:rgba(20,20,20,0.98);border-radius:18px;padding:24px 32px;box-shadow:0 4px 24px #000;display:none;max-width:340px;min-width:220px;max-height:70vh;overflow-y:auto;">
        <div style="font-size:22px;font-weight:bold;color:#00e6ff;margin-bottom:12px;text-align:center;">Pet Book</div>
        <div style="font-size:13px;color:#fff;margin-bottom:14px;text-align:center;line-height:1.4;">Unlock pets by prestiging. Pets have powerful effects and level up every 20,000m (max Lv60).</div>
        <div id="pet-book-list" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px 14px;"></div>
        <button id="close-pet-book" style="margin-top:18px;padding:7px 18px;border-radius:8px;background:#222;color:#00e6ff;font-size:15px;border:none;cursor:pointer;">Close</button>
    </div>
    <!-- Pet Book Button (icon only) -->
    <button id="open-pet-book" style="position:fixed;top:168px;right:24px;z-index:249;padding:12px 18px;border-radius:50px;background:#222;color:#00e6ff;font-size:22px;border:none;cursor:pointer;pointer-events:auto;margin-bottom:8px;display:inline-flex;align-items:center;gap:8px;">
        üêæ
    </button>
    <!-- Pet Switch Menu -->
    <div id="pet-switch-menu" style="display:none;position:fixed;top:calc(50% + 30px);left:50%;transform:translate(-50%,-50%);z-index:303;background:rgba(20,20,20,0.98);border-radius:18px;padding:24px 32px;box-shadow:0 4px 24px #000;max-width:340px;min-width:220px;max-height:70vh;overflow-y:auto;">
        <div style="font-size:22px;font-weight:bold;color:#00e6ff;margin-bottom:12px;text-align:center;">Switch Pet</div>
        <div id="pet-switch-list" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px 14px;"></div>
        <button id="close-pet-switch-menu" style="margin-top:18px;padding:7px 18px;border-radius:8px;background:#222;color:#00e6ff;font-size:15px;border:none;cursor:pointer;">Close</button>
    </div>
    <script>
    // Mutation Book logic (calls game.js function)
    window.addEventListener('DOMContentLoaded', function() {
        const mutationBookBtn = document.getElementById('open-mutation-book');
        const closeMutationBookBtn = document.getElementById('close-mutation-book');
        mutationBookBtn.onclick = function() {
            if (window.showMutationBook) window.showMutationBook();
        };
        closeMutationBookBtn.onclick = function() {
            document.getElementById('mutation-book-menu').style.display = 'none';
        };
        // Challenge window open/close logic
        document.getElementById('open-challenge-window').onclick = function() {
            document.getElementById('challenge-window').style.display = 'block';
        };
        document.getElementById('close-challenge-window').onclick = function() {
            document.getElementById('challenge-window').style.display = 'none';
        };
        // Pet Book logic
        const petBookBtn = document.getElementById('open-pet-book');
        const closePetBookBtn = document.getElementById('close-pet-book');
        petBookBtn.onclick = function() {
            if (window.showPetBook) window.showPetBook();
        };
        closePetBookBtn.onclick = function() {
            document.getElementById('pet-book-menu').style.display = 'none';
        };
        // Pet Switch Menu logic
        const petSwitchMenu = document.getElementById('pet-switch-menu');
        const petSwitchList = document.getElementById('pet-switch-list');
        const closePetSwitchMenuBtn = document.getElementById('close-pet-switch-menu');
        // Animation frame for pet icons
        let petSwitchFrame = 0;
        let petSwitchAnimTimer = null;
        function renderPetSwitchMenu() {
            petSwitchList.innerHTML = '';
            if (window.snail && window.petDefs && window.petSprites) {
                window.petDefs.forEach(pet => {
                    const unlocked = window.snail.unlockedPets && window.snail.unlockedPets.includes(pet.id);
                    if (!unlocked) return;
                    const div = document.createElement('div');
                    div.style = 'padding:8px 8px;border-radius:8px;min-width:0;word-break:break-word;font-size:13px;cursor:pointer;text-align:center;background:' + (window.snail.pet === pet.id ? '#222' : '');
                    // Remove animated canvas for sprite
                    // Only show name, description, and equipped status
                    div.innerHTML = `<b style='color:#00e6ff;'>${pet.name}</b><br><span style='font-size:12px;color:#ccc;'>${pet.desc}</span>${window.snail.pet === pet.id ? "<br><span style='color:#00e676;'>Equipped</span>" : ""}`;
                    div.onclick = function() {
                        window.snail.pet = pet.id;
                        window.snail.petLevel = window.snail.petLevel || 1;
                        petSwitchMenu.style.display = 'none';
                        if (window.updateUI) window.updateUI();
                        if (window.saveGame) window.saveGame();
                        if (petSwitchAnimTimer) clearInterval(petSwitchAnimTimer);
                    };
                    petSwitchList.appendChild(div);
                });
            }
        }
        window.showPetSwitchMenu = function() {
            petSwitchMenu.style.display = 'block';
            petSwitchFrame = 0;
            renderPetSwitchMenu();
            // Animate frames
            if (petSwitchAnimTimer) clearInterval(petSwitchAnimTimer);
            petSwitchAnimTimer = setInterval(() => {
                petSwitchFrame = (petSwitchFrame + 1) % 4;
                // Redraw all pet canvases
                Array.from(petSwitchList.children).forEach(div => {
                    if (div._drawFrame) div._drawFrame();
                });
            }, 180);
        };
        closePetSwitchMenuBtn.onclick = function() {
            petSwitchMenu.style.display = 'none';
            if (petSwitchAnimTimer) clearInterval(petSwitchAnimTimer);
        };
        // Leaderboard menu logic for mobile
        function isMobile() {
            return window.innerWidth <= 600;
        }
        const leaderboardBox = document.getElementById('leaderboard-box');
        const leaderboardMenu = document.getElementById('leaderboard-menu');
        const leaderboardMenuList = document.getElementById('leaderboard-menu-list');
        const closeLeaderboardMenuBtn = document.getElementById('close-leaderboard-menu');
        if (leaderboardBox && leaderboardMenu && leaderboardMenuList && closeLeaderboardMenuBtn) {
            leaderboardBox.onclick = function() {
                if (isMobile()) {
                    // Copy leaderboard content
                    leaderboardMenuList.innerHTML = document.getElementById('leaderboard-list').innerHTML;
                    leaderboardMenu.style.display = 'block';
                }
            };
            closeLeaderboardMenuBtn.onclick = function() {
                leaderboardMenu.style.display = 'none';
            };
        }
    });
    </script>
    <div id="ui-container">
        <div id="score-panel">
            <div id="distance" class="score">Distance: 0 m</div>
            <div id="slimePoints" class="score">Slime: 0</div>
            <div id="checkpoint" class="score">Checkpoint: Garden</div>
            <div id="prestige" class="score">Prestige: 0</div>
            <!-- Hazard timer moved here -->
            <div id="hazard-timer" class="info" style="margin-top:8px;"></div>
        </div>
        <div id="upgrade-panel">
            <button id="speedShell" class="upgrade-btn">üêö <span class="upgrade-name">Speed Shell</span><span class="upgrade-cost"></span></button>
            <button id="slimeBooster" class="upgrade-btn">üß™ <span class="upgrade-name">Slime Booster</span><span class="upgrade-cost"></span></button>
            <button id="turboSlime" class="upgrade-btn">‚ö° <span class="upgrade-name">Turbo Slime</span><span class="upgrade-cost"></span></button>
        </div>
        <button id="prestigeBtn" class="prestige-btn" style="display:inline-flex;align-items:center;gap:8px;">
            ü¶ë <span class="prestige-name">Prestige: New Species</span>
            <span class="prestige-cost"></span>
            <span class="prestige-level"></span>
        </button>
    </div>
    <div id="leaderboard-box">
        <div id="leaderboard-title"><b>Leaderboard</b></div>
        <div id="leaderboard-list">Loading...</div>
        <div id="leaderboard-refresh">Refresh in <span id="leaderboard-timer">10</span>s</div>
    </div>
    <!-- Leaderboard Modal/Menu for mobile -->
    <div id="leaderboard-menu" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:999;background:rgba(20,20,20,0.98);border-radius:18px;padding:24px 32px;box-shadow:0 4px 24px #000;max-width:340px;min-width:180px;max-height:70vh;overflow-y:auto;">
        <div style="font-size:22px;font-weight:bold;color:#ffd700;margin-bottom:12px;text-align:center;">Leaderboard</div>
        <div id="leaderboard-menu-list" style="margin-bottom:12px;">Loading...</div>
        <button id="close-leaderboard-menu" style="margin-top:18px;padding:7px 18px;border-radius:8px;background:#222;color:#ffd700;font-size:15px;border:none;cursor:pointer;">Close</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <script src="scripts/game.js"></script>
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        // Ensure global references for pet switch menu
        window.snail = window.snail || snail;
        window.petDefs = window.petDefs || petDefs;
        window.petSprites = window.petSprites || petSprites;
        // Mutation Book logic (calls game.js function)
        const mutationBookBtn = document.getElementById('open-mutation-book');
        const closeMutationBookBtn = document.getElementById('close-mutation-book');
        mutationBookBtn.onclick = function() {
            if (window.showMutationBook) window.showMutationBook();
        };
        closeMutationBookBtn.onclick = function() {
            document.getElementById('mutation-book-menu').style.display = 'none';
        };
        // Challenge window open/close logic
        document.getElementById('open-challenge-window').onclick = function() {
            document.getElementById('challenge-window').style.display = 'block';
        };
        document.getElementById('close-challenge-window').onclick = function() {
            document.getElementById('challenge-window').style.display = 'none';
        };
        // Pet Book logic
        const petBookBtn = document.getElementById('open-pet-book');
        const closePetBookBtn = document.getElementById('close-pet-book');
        petBookBtn.onclick = function() {
            if (window.showPetBook) window.showPetBook();
        };
        closePetBookBtn.onclick = function() {
            document.getElementById('pet-book-menu').style.display = 'none';
        };
        // Pet Switch Menu logic
        const petSwitchMenu = document.getElementById('pet-switch-menu');
        const petSwitchList = document.getElementById('pet-switch-list');
        const closePetSwitchMenuBtn = document.getElementById('close-pet-switch-menu');
        // Animation frame for pet icons
        let petSwitchFrame = 0;
        let petSwitchAnimTimer = null;
        function renderPetSwitchMenu() {
            petSwitchList.innerHTML = '';
            if (window.snail && window.petDefs && window.petSprites) {
                window.petDefs.forEach(pet => {
                    const unlocked = window.snail.unlockedPets && window.snail.unlockedPets.includes(pet.id);
                    if (!unlocked) return;
                    const div = document.createElement('div');
                    div.style = 'padding:8px 8px;border-radius:8px;min-width:0;word-break:break-word;font-size:13px;cursor:pointer;text-align:center;background:' + (window.snail.pet === pet.id ? '#222' : '');
                    // Remove animated canvas for sprite
                    // Only show name, description, and equipped status
                    div.innerHTML = `<b style='color:#00e6ff;'>${pet.name}</b><br><span style='font-size:12px;color:#ccc;'>${pet.desc}</span>${window.snail.pet === pet.id ? "<br><span style='color:#00e676;'>Equipped</span>" : ""}`;
                    div.onclick = function() {
                        window.snail.pet = pet.id;
                        window.snail.petLevel = window.snail.petLevel || 1;
                        petSwitchMenu.style.display = 'none';
                        if (window.updateUI) window.updateUI();
                        if (window.saveGame) window.saveGame();
                        if (petSwitchAnimTimer) clearInterval(petSwitchAnimTimer);
                    };
                    petSwitchList.appendChild(div);
                });
            }
        }
        window.showPetSwitchMenu = function() {
            petSwitchMenu.style.display = 'block';
            petSwitchFrame = 0;
            renderPetSwitchMenu();
            // Animate frames
            if (petSwitchAnimTimer) clearInterval(petSwitchAnimTimer);
            petSwitchAnimTimer = setInterval(() => {
                petSwitchFrame = (petSwitchFrame + 1) % 4;
                // Redraw all pet canvases
                Array.from(petSwitchList.children).forEach(div => {
                    if (div._drawFrame) div._drawFrame();
                });
            }, 180);
        };
        closePetSwitchMenuBtn.onclick = function() {
            petSwitchMenu.style.display = 'none';
            if (petSwitchAnimTimer) clearInterval(petSwitchAnimTimer);
        };
        // Leaderboard menu logic for mobile
        function isMobile() {
            return window.innerWidth <= 600;
        }
        const leaderboardBox = document.getElementById('leaderboard-box');
        const leaderboardMenu = document.getElementById('leaderboard-menu');
        const leaderboardMenuList = document.getElementById('leaderboard-menu-list');
        const closeLeaderboardMenuBtn = document.getElementById('close-leaderboard-menu');
        if (leaderboardBox && leaderboardMenu && leaderboardMenuList && closeLeaderboardMenuBtn) {
            leaderboardBox.onclick = function() {
                if (isMobile()) {
                    // Copy leaderboard content
                    leaderboardMenuList.innerHTML = document.getElementById('leaderboard-list').innerHTML;
                    leaderboardMenu.style.display = 'block';
                }
            };
            closeLeaderboardMenuBtn.onclick = function() {
                leaderboardMenu.style.display = 'none';
            };
        }
    });
    </script>
</body>
</html>